name: CI/CD

on:
  push:
    branches:
      - 'searce_yash_gh_actions_test'

env:
  STAGING_CLUSTER: "ismfg-scratch"

jobs:
  install-apache-server:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Gcloud CLI, Helm, Kubectl
        run: | 
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update && sudo apt-get install google-cloud-cli


          #curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-474.0.0-linux-x86_64.tar.gz
          #tar -xf google-cloud-cli-474.0.0-linux-x86_64.tar.gz
          #./google-cloud-sdk/install.sh --quiet

          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

          #curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          #chmod 700 get_helm.sh
          #./get_helm.sh

          sudo apt-get install google-cloud-cli-gke-gcloud-auth-plugin


      - name: Set the Remote proxy to access GKE cluster
        run: |
          cat > /root/.kube/config << EOF 
            apiVersion: v1
            clusters:
            - cluster:
                certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVMRENDQXBTZ0F3SUJBZ0lRVFNleTRqb2w5dkRKbzVhT09RZE82VEFOQmdrcWhraUc5dzBCQVFzRkFEQXYKTVMwd0t3WURWUVFERXlRM01qUXdZemN3TlMxaVlqYzFMVFJoWldVdFlqa3hOeTB4TXpRMU1EVmxPVGRsWVRRdwpJQmNOTWpRd05ERTJNRGd6TnpBM1doZ1BNakExTkRBME1Ea3dPVE0zTURkYU1DOHhMVEFyQmdOVkJBTVRKRGN5Ck5EQmpOekExTFdKaU56VXROR0ZsWlMxaU9URTNMVEV6TkRVd05XVTVOMlZoTkRDQ0FhSXdEUVlKS29aSWh2Y04KQVFFQkJRQURnZ0dQQURDQ0FZb0NnZ0dCQUxhYTUvZnJZalZpTlpWR0I5Tm4xcTIxZnd6dTFFRFN3TDNsOEhKSgpwTmovdEJKUXhOSGlZUHA4dVNnbnhsM1gwazlPM3JzR0V0dURUZXRwL09jKzVDTlVNTjA1NFJPT09jQUZ3NVplClZSNnZYcWR1SU41RUo5RGlTaFJWYkZVZ0N5eDl2MHJGNTJNWG5pOE5MTFI3Q0lOSE9Xd3RtU3RJdEZVVUo1OFkKcUxFYlhva25taDM4YVRPbExXdFlLK3g0a2FTTFRYcXl2L052TU9EakVnN1NhbXBpU3JaYUVIdkhPTGM5L1pjcgo2MmtQRVZ6ZzdpREhFREszUk9GT2FQZXNEbTNRZ0tJOVA2Qmx3eS9xRjVJY1UrL0EwRFMrWFhVRTRDZjdqU2h1CkpXMDlnY3d0OFhXK2g0Y0pzK3ZpdVViaU1HWERKcS9NSUpERkJ1MDZkaXNDdXFhZ2VlTEtIdmNRSDFscVdXRTQKSHA4WVRHQmZ5M2dXZHREcUU1RjU5RWpxYkdtZ2p0NVFML0JTb3Y3Zmlkdks5L1NEUXJwb2I2MEU2OVNPM0tZbApZK2E1QnhWaG1xaUVpYTR1TzUwMjFXR3BOWHF4TmhMaVJsbXlhTGZycXM5VTRpVVY1WVVZaGlWOHBCSHQxT0txCnR0cFZGSStDbVZORGFMeFpWQWR0dmIwR3pRSURBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DQWdRd0R3WUQKVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVU5Q1RLcDE1cnRxVVc0U0F6Tk9XWFJPOUpZbGd3RFFZSgpLb1pJaHZjTkFRRUxCUUFEZ2dHQkFBMkp3R3BoZ3gvY1ZWNDVhSDVJZFdxS1kxY3BnTXBHbVpoUng2RFNRMDJoCkNDL0doN1dlWXBFM1JpNSs2NnhhWEJQcjFDK3lvbnMrbDB5aVhLdVVwSUlGNEdmbEx3VjJiVlpqVnlaZUFXOUkKekYxUGkxQW1lZzVWaXRGZ3N3S3ZRb3grTVNXN3JBbm5VazhyZldSellORUc2T1JPL1Q2WmYweUVVd2RYbjVIZwpIdkZpMjFTYjRIRDE5MFl2TStvQnlsWUlVbldHbTNNSGxyYXJUWFBJdUQwbDJOZ1pQcTd3d1p0bGFlWU9ZcnRqCnZxV3p2UFE4bTRnMkFlN1l3ZGVRZE8xR0REQ1diM1o3V3h0MlducElXZUFkU3preVE1cXlPRGl1V2JaU0N3bCsKZDQxOEl6VzYyQ2lja2NJT3pPTmI1WkNKLytmYmNDWkZ2Uk9MbW92THlTR2NtQk4rUUhiMDdoRkozUnkxVHdHOQp6S29za2VEcENOM0pURnNjYm9oWDdPZ0lwMnU3bEd4cGZwYVlSWE5XZy9HYXNOOVRpcTFrR1p1OVhzQzQrNWQ1CmdwWGEzaGJKU0JrYjJHL1M5TktjNUlsUTBFcnRNVjV4cjFmNHZqczNCWDBiR21CanA1QS9BSE4vOVJBejF4eU8KZUh3MlA1WFBWeDlhaWdmM2VGRjVaUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
                server: https://10.255.216.2
              name: gke_ismfg-scratch_europe-west2_ismfg-scratch
            contexts:
            - context:
                cluster: gke_ismfg-scratch_europe-west2_ismfg-scratch
                user: gke_ismfg-scratch_europe-west2_ismfg-scratch
              name: gke_ismfg-scratch_europe-west2_ismfg-scratch
            current-context: gke_ismfg-scratch_europe-west2_ismfg-scratch
            kind: Config
            preferences: {}
            users:
            - name: gke_ismfg-scratch_europe-west2_ismfg-scratch
              user:
                exec:
                  apiVersion: client.authentication.k8s.io/v1beta1
                  command: gke-gcloud-auth-plugin
                  installHint: Install gke-gcloud-auth-plugin for use with kubectl by following
                    https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl#install_plugin
                  provideClusterInfo: true
          EOF
          export HTTPS_PROXY=35.246.41.60:8888
          export HTTP_PROXY=35.246.41.60:8888


      - name: Install test apache/httpd through helm
        run: |  
          kubectl create ns apache
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm install apache bitnami/apache --set service.type=LoadBalancer -n apache
